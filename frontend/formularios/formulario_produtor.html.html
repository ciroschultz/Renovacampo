<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Renova Campo — Submissão de Projeto (Produtor / Mão de obra) - Profissional</title>
  <style>
    :root{
      --accent:#2b8a3e;
      --verde:#2e7d32;
      --verde-esc:#256628;
      --muted:#666;
      --bg:#f7f9f8;
      --card:#ffffff;
      --maxw:980px;
      --radius:12px;
      --gap:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#123;}
    .container{max-width:var(--maxw);margin:28px auto;padding:20px}
    /* header with logo left, title right */
    header.app-header{display:flex;gap:20px;align-items:center;margin-bottom:12px}
    .logo{background:var(--card);padding:8px 12px;border-radius:14px;box-shadow:0 6px 18px rgba(10,20,10,0.06);display:flex;align-items:center}
    .logo img{height:62px;display:block}
    .title-block{flex:1;display:flex;flex-direction:column;justify-content:center;gap:6px}
    .title-block h1{margin:0;font-size:20px;color:var(--verde)}
    .title-block p.lead{margin:0;color:var(--muted);font-size:13px}

    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(10,10,10,0.06)}
    .steps{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
    .step-pill{padding:8px 10px;border-radius:999px;background:#eef6ee;color:var(--muted);font-size:13px}
    .step-pill.active{background:linear-gradient(180deg,#eaf8ea,#e3f5e3);color:var(--verde);box-shadow:0 4px 8px rgba(46,125,50,0.06)}
    .progress{height:10px;background:#e6efe6;border-radius:999px;overflow:hidden;margin:12px 0;position:relative}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#60bd6b);width:0%;transition:width .36s ease}
    .progress-text{font-size:13px;color:var(--muted);margin-bottom:8px}

    form{margin-top:6px}
    fieldset{border:0;padding:0;margin:0;display:none;opacity:0;transform:translateY(6px);transition:opacity .28s ease, transform .28s ease}
    fieldset.active{display:block;opacity:1;transform:none}
    legend.section-title{font-size:18px;color:var(--verde);margin:0 0 10px 0;font-weight:700}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .full{grid-column:1/-1}
    label{display:block;font-size:13px;color:#2b2b2b;margin-bottom:6px;font-weight:600}
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="date"], select, textarea{
      width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e7e3;background:#fff;box-sizing:border-box;font-size:14px;color:#222
    }
    textarea{min-height:110px;resize:vertical;padding-top:12px}
    .muted{font-size:13px;color:var(--muted);margin-top:6px}

    .actions{display:flex;justify-content:space-between;align-items:center;margin-top:20px;gap:12px}
    .btn{background:var(--verde);color:#fff;border:0;padding:10px 18px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 6px 16px rgba(46,125,50,0.14)}
    .btn.secondary{background:#fff;color:var(--verde);border:1px solid #e6efe6}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .step-indicator{font-size:13px;color:var(--muted)}

    .tooltip{
      display:inline-block;position:relative;margin-left:8px;color:var(--muted);cursor:help;
    }
    .tooltip .tiptext{
      visibility:hidden;opacity:0;width:240px;background:#fff;border:1px solid #e3e7e3;padding:8px;border-radius:8px;position:absolute;z-index:20;left:0;top:26px;box-shadow:0 6px 18px rgba(0,0,0,0.06);font-size:13px;color:#222;transition:opacity .18s;
    }
    .tooltip:hover .tiptext{visibility:visible;opacity:1}

    .file-list{font-size:13px;color:var(--muted);margin-top:10px}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}

    /* small badges */
    .badge{display:inline-block;background:#eef6ef;color:var(--verde);padding:6px 10px;border-radius:999px;font-weight:700;margin-left:6px;font-size:13px}

    @media (max-width:820px){
      .grid{grid-template-columns:1fr}
      .logo img{height:54px}
      .title-block h1{font-size:16px}
    }
  </style>
  <!-- Scripts de integracao com API -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/form-mappers.js"></script>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="logo" aria-hidden="true"><img src="Captura de tela 2025-10-07 210445.png" alt="Logo Renova Campo"></div>
      <div class="title-block">
        <h1>Renova Campo — Formulário detalhado para submissão de projeto (Produtores / Mão de obra)</h1>
        <p class="lead">Preencha com atenção. Tempo estimado: 20–30 minutos. Campos obrigatórios têm (<span style="color:#a00">*</span>).</p>
      </div>
    </header>

    <section class="card" aria-labelledby="formTitle">
      <div class="steps" aria-hidden="true">
        <div class="step-pill">1 Identificação</div>
        <div class="step-pill">2 Resumo do Projeto</div>
        <div class="step-pill">3 Plano Técnico</div>
        <div class="step-pill">4 Equipe & Mão-de-obra</div>
        <div class="step-pill">5 Máquinas & Insumos</div>
        <div class="step-pill">6 Ambiental & Certs</div>
        <div class="step-pill">7 Orçamento</div>
        <div class="step-pill">8 Cronograma</div>
        <div class="step-pill">9 Riscos & Monitoramento</div>
        <div class="step-pill">10 Deslocamento & Anexos</div>
        <div class="step-pill">11 Declaração</div>
      </div>

      <div class="progress-text" id="progressText">Etapa 1 de 11 — 0% concluído</div>
      <div class="progress" aria-hidden="true"><i id="progressBar" style="width:0%"></i></div>

      <form id="producerForm" enctype="multipart/form-data" novalidate>

        <!-- 1 Identificação -->
        <fieldset class="active" data-step="1">
          <legend class="section-title">1. Identificação</legend>
          <div class="grid">
            <div>
              <label for="nome">Nome completo / razão social <span style="color:#a00">*</span></label>
              <input id="nome" name="nome" type="text" required>
            </div>
            <div>
              <label for="cpf">CPF / CNPJ <span style="color:#a00">*</span></label>
              <input id="cpf" name="cpf" type="text" required placeholder="000.000.000-00 ou 00.000.000/0000-00">
            </div>

            <div>
              <label for="funcao">Função / cargo</label>
              <input id="funcao" name="funcao" type="text" placeholder="Ex: Produtor, técnico, coordenador">
            </div>
            <div>
              <label for="respTecCPF">CPF responsável técnico (se houver)</label>
              <input id="respTecCPF" name="respTecCPF" type="text" placeholder="000.000.000-00">
            </div>

            <div class="full">
              <label for="endereco">Endereço completo (município / UF)</label>
              <input id="endereco" name="endereco" type="text">
            </div>

            <div>
              <label for="telefone">Telefone / WhatsApp <span style="color:#a00">*</span></label>
              <input id="telefone" name="telefone" type="tel" required placeholder="(99) 9 9999-9999">
            </div>
            <div>
              <label for="email">E-mail <span style="color:#a00">*</span></label>
              <input id="email" name="email" type="email" required>
            </div>

            <div>
              <label for="experiencia">Anos de experiência no campo</label>
              <input id="experiencia" name="experiencia" type="number" min="0">
            </div>
            <div>
              <label for="perfilProd">Perfil do produtor</label>
              <select id="perfilProd" name="perfilProd">
                <option>Produtor familiar</option>
                <option>Empreendedor agrícola</option>
                <option>Cooperativa</option>
                <option>Empresa</option>
                <option>Outro</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 1 de 11</div>
            <div><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 2 Resumo do Projeto -->
        <fieldset data-step="2">
          <legend class="section-title">2. Resumo do Projeto</legend>
          <div class="grid">
            <div>
              <label for="titulo">Título do projeto</label>
              <input id="titulo" name="titulo" type="text">
            </div>
            <div>
              <label for="palavras">Palavras-chave</label>
              <input id="palavras" name="palavras" type="text" placeholder="ex: hortaliças, irrigação, agrofloresta">
            </div>

            <div>
              <label for="cultura">Cultura(s) principal(is)</label>
              <input id="cultura" name="cultura" type="text">
            </div>
            <div>
              <label for="tipo">Tipo de produção</label>
              <select id="tipo" name="tipo">
                <option>Convencional</option>
                <option>Orgânica</option>
                <option>Regenerativa</option>
                <option>Agroecológica</option>
                <option>Silvicultura</option>
              </select>
            </div>

            <div class="full">
              <label for="publico">Público beneficiado / Escopo social</label>
              <input id="publico" name="publico" type="text" placeholder="Ex: 10 famílias locais / cooperativa X">
            </div>

            <div class="full">
              <label for="resumoProjeto">Resumo (até 300 palavras)</label>
              <textarea id="resumoProjeto" name="resumoProjeto" maxlength="2000" placeholder="Descreva objetivo, escala e impacto"></textarea>
              <div class="note">Dica: destaque objetivo, escala, número de beneficiados e impacto ambiental.</div>
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 2 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 3 Plano Técnico -->
        <fieldset data-step="3">
          <legend class="section-title">3. Plano Técnico <span class="tooltip">ⓘ<span class="tiptext">Detalhe preparo, variedades, espaçamento, irrigação, fertilidade e manejo fitossanitário.</span></span></legend>
          <div class="grid">
            <div>
              <label for="areaNecessaria">Área necessária (ha)</label>
              <input id="areaNecessaria" name="areaNecessaria" type="number" step="0.1" min="0">
            </div>
            <div>
              <label for="tipoSolo">Tipo de solo / condicionantes</label>
              <input id="tipoSolo" name="tipoSolo" type="text">
            </div>

            <div>
              <label for="irrig">Irrigação necessária?</label>
              <select id="irrig" name="irrig"><option>Não</option><option>Sim - pivô</option><option>Sim - gotejamento</option><option>Parcial</option></select>
            </div>
            <div>
              <label for="tecManejo">Tecnologia de manejo</label>
              <select id="tecManejo" name="tecManejo"><option>Plantio direto</option><option>ILPF</option><option>Rotação de culturas</option><option>Outro</option></select>
            </div>

            <div class="full">
              <label for="descricaoTec">Descrição técnica detalhada</label>
              <textarea id="descricaoTec" name="descricaoTec" placeholder="Preparo do solo, adubação, tratos culturais, espaçamento, variedades, insumos técnicos..."></textarea>
            </div>

            <div>
              <label for="assTec">Necessita assistência técnica?</label>
              <select id="assTec" name="assTec"><option>Não</option><option>Sim - regular</option><option>Sim - episódica</option></select>
            </div>
            <div>
              <label for="tempoExec">Tempo estimado de execução (meses)</label>
              <input id="tempoExec" name="tempoExec" type="number" min="0">
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 3 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 4 Equipe & Mão-de-obra -->
        <fieldset data-step="4">
          <legend class="section-title">4. Equipe &amp; Mão-de-obra</legend>
          <div class="grid">
            <div>
              <label for="numTrabalhadores">Número estimado de trabalhadores</label>
              <input id="numTrabalhadores" name="numTrabalhadores" type="number" min="0">
            </div>
            <div>
              <label for="regimeTrab">Regime de contratação</label>
              <select id="regimeTrab" name="regimeTrab"><option>CLT</option><option>Autônomo</option><option>Diarista</option><option>Cooperado</option></select>
            </div>

            <div class="full">
              <label for="cargos">Cargos / funções previstas</label>
              <textarea id="cargos" name="cargos" placeholder="Operador de máquina, técnico agrícola, supervisão..."></textarea>
            </div>

            <div class="full">
              <label for="capacitacao">Capacitação necessária (detalhar)</label>
              <textarea id="capacitacao" name="capacitacao" placeholder="Treinamentos, duração, certificações exigidas"></textarea>
            </div>

            <div>
              <label for="salarioMedio">Salário / remuneração média prevista</label>
              <input id="salarioMedio" name="salarioMedio" type="text" placeholder="R$/mês ou R$/ha">
            </div>
            <div>
              <label for="numeroVagas">Vagas locais disponíveis (nº)</label>
              <input id="numeroVagas" name="numeroVagas" type="number" min="0">
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 4 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 5 Máquinas & Insumos -->
        <fieldset data-step="5">
          <legend class="section-title">5. Máquinas &amp; Insumos</legend>
          <div class="grid">
            <div class="full">
              <label for="equip">Equipamentos / máquinas necessários</label>
              <textarea id="equip" name="equip" placeholder="Tratores, implementos, colhedoras, transportes..."></textarea>
            </div>

            <div class="full">
              <label for="insumos">Insumos principais (sementes, fertilizantes, defensivos)</label>
              <textarea id="insumos" name="insumos" placeholder="Marcas, volumes por ha, especificações"></textarea>
            </div>

            <div>
              <label for="fornPref">Fornecedores preferenciais</label>
              <input id="fornPref" name="fornPref" type="text">
            </div>
            <div>
              <label for="estoque">Necessidade de armazenagem / estoque</label>
              <select id="estoque" name="estoque"><option>Não</option><option>Sim - pequena</option><option>Sim - grande</option></select>
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 5 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 6 Ambiental & Certificações -->
        <fieldset data-step="6">
          <legend class="section-title">6. Ambiental &amp; Certificações</legend>
          <div class="grid">
            <div class="full">
              <label for="praticasAmb">Práticas sustentáveis previstas</label>
              <textarea id="praticasAmb" name="praticasAmb" placeholder="Ex: plantio direto, faixas de conservação, adubação verde..."></textarea>
            </div>

            <div>
              <label for="certsObtidas">Certificações obtidas</label>
              <input id="certsObtidas" name="certsObtidas" type="text" placeholder="Orgânico, Fairtrade, etc.">
            </div>
            <div>
              <label for="interesseCert">Interesse em certificação via Renova Campo</label>
              <select id="interesseCert" name="interesseCert"><option>Não</option><option>Sim - orgânico</option><option>Sim - ESG/rastreabilidade</option><option>Interessado em orientação</option></select>
            </div>

            <div class="full">
              <label for="planoMitig">Plano de mitigação ambiental (resumo)</label>
              <textarea id="planoMitig" name="planoMitig" placeholder="Medidas para reduzir impactos"></textarea>
            </div>

            <div>
              <label for="bioinsumos">Uso de bioinsumos / manejo biológico?</label>
              <select id="bioinsumos" name="bioinsumos"><option>Não</option><option>Sim</option></select>
            </div>
            <div>
              <label for="restricoes">Existem restrições/licenças ambientais?</label>
              <input id="restricoes" name="restricoes" type="text">
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 6 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 7 Orçamento -->
        <fieldset data-step="7">
          <legend class="section-title">7. Orçamento</legend>
          <div class="grid">
            <div>
              <label for="custoTotal">Estimativa de custo total (R$)</label>
              <input id="custoTotal" name="custoTotal" type="text" placeholder="R$ 0,00">
            </div>
            <div>
              <label for="custoHa">Custo por hectare estimado (R$/ha)</label>
              <input id="custoHa" name="custoHa" type="text" placeholder="R$ 0,00">
            </div>

            <div class="full">
              <label for="detalhamentoCustos">Detalhamento de custos por etapa</label>
              <textarea id="detalhamentoCustos" name="detalhamentoCustos" placeholder="Preparo, plantio, tratos, colheita, logística..."></textarea>
            </div>

            <div>
              <label for="valorSolicitado">Valor solicitado ao investidor (R$)</label>
              <input id="valorSolicitado" name="valorSolicitado" type="text" placeholder="R$ 0,00">
            </div>
            <div>
              <label for="fontesContrap">Fontes de contrapartida</label>
              <input id="fontesContrap" name="fontesContrap" type="text" placeholder="mão de obra, insumos, equipamentos...">
            </div>

            <div class="full">
              <label for="retornoEstim">Retorno financeiro estimado (ex: % anual ou R$/ha)</label>
              <input id="retornoEstim" name="retornoEstim" type="text">
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 7 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 8 Cronograma -->
        <fieldset data-step="8">
          <legend class="section-title">8. Cronograma</legend>
          <div class="grid">
            <div>
              <label for="inicioPrev">Data de início prevista</label>
              <input id="inicioPrev" name="inicioPrev" type="date">
            </div>
            <div>
              <label for="duracao">Duração total (meses)</label>
              <input id="duracao" name="duracao" type="number" min="0">
            </div>

            <div class="full">
              <label for="marcosEntreg">Marcos / entregáveis (com prazos)</label>
              <textarea id="marcosEntreg" name="marcosEntreg" placeholder="Planejamento - M1; Preparo - M2; Plantio - M3; Check-ins mensais..."></textarea>
            </div>

            <div class="full">
              <label for="periodicidadeRel">Periodicidade de relatórios e entregas</label>
              <select id="periodicidadeRel" name="periodicidadeRel"><option>Semanal</option><option>Quinzenal</option><option>Mensal</option><option>Trimestral</option></select>
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 8 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 9 Riscos & Monitoramento -->
        <fieldset data-step="9">
          <legend class="section-title">9. Riscos &amp; Monitoramento</legend>
          <div class="grid">
            <div class="full">
              <label for="riscos">Principais riscos identificados</label>
              <textarea id="riscos" name="riscos" placeholder="Climáticos, pragas, logísticos, financeiros..."></textarea>
            </div>

            <div class="full">
              <label for="mitigacoes">Plano de mitigação</label>
              <textarea id="mitigacoes" name="mitigacoes" placeholder="Ações preventivas e corretivas"></textarea>
            </div>

            <div>
              <label for="monitoramento">Monitoramento desejado</label>
              <select id="monitoramento" name="monitoramento"><option>Fotos e relatórios</option><option>Drones</option><option>Sensores IoT</option><option>Aplicativo / checklist</option></select>
            </div>

            <div>
              <label for="freqMonitor">Frequência de monitoramento</label>
              <select id="freqMonitor" name="freqMonitor"><option>Semanal</option><option>Mensal</option><option>Por safra</option></select>
            </div>

            <div class="full">
              <label for="indicadores">Indicadores de sucesso / KPIs</label>
              <textarea id="indicadores" name="indicadores" placeholder="Produtividade, % de área restaurada, empregos gerados..."></textarea>
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 9 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 10 Deslocamento & Anexos -->
        <fieldset data-step="10">
          <legend class="section-title">10. Deslocamento &amp; Anexos</legend>
          <div class="grid">
            <div>
              <label for="distancia">Distância máxima que aceita trabalhar (km)</label>
              <input id="distancia" name="distancia" type="number" min="0">
            </div>
            <div>
              <label for="transporteProp">Possui transporte próprio?</label>
              <select id="transporteProp" name="transporteProp"><option>Sim</option><option>Não</option></select>
            </div>

            <div>
              <label for="mudanca">Disponibilidade para mudança temporária</label>
              <select id="mudanca" name="mudanca"><option>Não</option><option>Sim - curto prazo</option><option>Sim - longo prazo</option></select>
            </div>
            <div>
              <label for="regioesPref">Regiões preferenciais</label>
              <input id="regioesPref" name="regioesPref" type="text">
            </div>

            <div class="full">
              <label for="arquivoProjeto">Anexe projeto técnico (PDF/DOC) e fotos (JPG/PNG)</label>
              <input id="arquivoProjeto" name="arquivoProjeto" type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
              <div class="file-list" id="fileList">Nenhum arquivo selecionado</div>
            </div>

            <div class="full">
              <label for="linkAux">Link adicional (Drive / Vídeo)</label>
              <input id="linkAux" name="linkAux" type="text" placeholder="Cole um link, se houver">
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 10 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="nextStep()">Próximo →</button></div>
          </div>
        </fieldset>

        <!-- 11 Declaração -->
        <fieldset data-step="11">
          <legend class="section-title">11. Declaração</legend>
          <div class="grid">
            <div class="full">
              <label><input id="declaracao" name="declaracao" type="checkbox" required> &nbsp;Declaro que as informações prestadas são verdadeiras e autorizo a Renova Campo a utilizar os dados para análise e contato.</label>
            </div>

            <div class="full">
              <label><input id="consentPesquisa" name="consentPesquisa" type="checkbox"> &nbsp;Autorizo o uso anônimo dos dados para pesquisa e desenvolvimento (opcional)</label>
            </div>

            <div class="full">
              <label for="observ">Observações finais</label>
              <textarea id="observ" name="observ" placeholder="Informações complementares"></textarea>
            </div>
          </div>

          <div class="actions">
            <div class="step-indicator">Passo 11 de 11</div>
            <div><button type="button" class="btn secondary" onclick="prevStep()">← Anterior</button><button type="button" class="btn" onclick="finalizeForm()">Enviar e Baixar CSV</button></div>
          </div>
        </fieldset>

      </form>

      <div id="successBox" class="card" style="display:none;margin-top:14px;border:1px solid #e6f6e6;background:linear-gradient(180deg,#eaf7ed,#ffffff);text-align:center;padding:18px;color:var(--verde);font-weight:700">
        ✅ Projeto enviado com sucesso! Nossa equipe entrará em contato em breve.
      </div>

    </section>

    <footer>Renova Campo · Transformando terras ociosas em oportunidades sustentáveis</footer>
  </div>

  <script>
    (function(){
      const form = document.getElementById('producerForm');
      const steps = Array.from(form.querySelectorAll('fieldset'));
      const pills = Array.from(document.querySelectorAll('.step-pill'));
      const total = steps.length;
      let current = 0;
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const fileInput = document.getElementById('arquivoProjeto');
      const fileList = document.getElementById('fileList');

      function updateProgress(){
        const pct = Math.round(((current) / (total - 1)) * 100);
        progressBar.style.width = pct + '%';
        progressText.textContent = `Etapa ${current+1} de ${total} — ${pct}% concluído`;
      }

      function updatePills(){
        pills.forEach((p,i)=>{
          p.classList.toggle('active', i===current);
        });
      }

      function showStep(index){
        current = Math.max(0, Math.min(index, total-1));
        steps.forEach((fs,i)=> fs.classList.toggle('active', i === current));
        updatePills();
        updateProgress();
        const first = steps[current].querySelector('input,select,textarea,button');
        if(first) first.focus();
        window.scrollTo({top:0,behavior:'smooth'});
      }

      window.nextStep = function(){
        if(!validateStep(current)) return;
        if(current < total - 1) showStep(current + 1);
      };
      window.prevStep = function(){ if(current>0) showStep(current - 1); };

      // masks
      function maskCPF(value){
        const v = value.replace(/\D/g,'');
        if(v.length<=11){
          return v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/,'$1.$2.$3-$4').replace(/[-.]$/,'');
        } else {
          return v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/,'$1.$2.$3/$4-$5').replace(/[-./]$/,'');
        }
      }
      function maskPhone(v){
        const x = v.replace(/\D/g,'').slice(0,11);
        if(x.length<=10) return x.replace(/(\d{2})(\d{4})(\d{0,4})/,'($1) $2-$3').replace(/[-]$/,'');
        return x.replace(/(\d{2})(\d{5})(\d{0,4})/,'($1) $2-$3');
      }
      function maskMoney(v){
        const n = v.replace(/\D/g,'');
        const number = (Number(n)/100).toFixed(2);
        return 'R$ ' + number.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }

      // attach masks
      const cpfEl = document.getElementById('cpf');
      const respCpfEl = document.getElementById('respTecCPF');
      const telEl = document.getElementById('telefone');
      const moneyFields = ['custoTotal','custoHa','valorSolicitado'];
      [cpfEl, respCpfEl].forEach(el=>{
        if(!el) return;
        el.addEventListener('input', e=>{ e.target.value = maskCPF(e.target.value); });
      });
      if(telEl) telEl.addEventListener('input', e=>{ e.target.value = maskPhone(e.target.value); });
      moneyFields.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', e=>{ e.target.value = maskMoney(e.target.value); });
      });

      // file preview
      if(fileInput){
        fileInput.addEventListener('change', e=>{
          const files = Array.from(e.target.files || []);
          fileList.textContent = files.length ? files.map(f => `${f.name} (${Math.round(f.size/1024)} KB)`).join(' • ') : 'Nenhum arquivo selecionado';
        });
      }

      // collect data
      function collectData(){
        const els = form.elements;
        const data = {};
        for(let i=0;i<els.length;i++){
          const el = els[i];
          if(!el.name) continue;
          if(el.type==='checkbox') data[el.name] = el.checked ? 'Sim' : 'Não';
          else if(el.type==='file') data[el.name] = (el.files && el.files.length) ? Array.from(el.files).map(f=>f.name).join('; ') : '';
          else data[el.name] = el.value;
        }
        data.timestamp = new Date().toISOString();
        return data;
      }

      async function finalizeForm(){
        // ensure declaration
        const decl = document.getElementById('declaracao');
        if(!decl || !decl.checked){ alert('É necessário concordar com a declaração.'); decl?.focus(); return; }
        // basic contact validation
        const nome = document.getElementById('nome');
        const email = document.getElementById('email');
        if(!nome.value){ alert('Preencha seu nome.'); nome.focus(); return; }
        if(!email.value){ alert('Preencha seu e-mail.'); email.focus(); return; }

        const data = collectData();
        const successBox = document.getElementById('successBox');

        // Mostrar loading
        successBox.style.display = 'block';
        successBox.innerHTML = '<strong>Enviando...</strong> Aguarde enquanto salvamos seu projeto no sistema.';
        successBox.style.color = 'var(--verde)';

        try {
          // Mapear dados para o formato do backend usando FormMappers
          const projectData = FormMappers.mapProjetoToProject(data);

          // Enviar para a API
          const response = await ProjectService.create(projectData);

          // Sucesso!
          form.style.display = 'none';
          successBox.innerHTML = `<strong>✅ Projeto enviado com sucesso!</strong><br>
            "${projectData.name}" foi salvo no sistema com ID #${response.id}.<br>
            <span style="font-size:13px">Nossa equipe entrará em contato em breve.</span>`;

          // Salvar backup local
          localStorage.setItem('renova_produtor_last', JSON.stringify(data));

          // Opcional: gerar CSV como backup
          if(confirm('Deseja também baixar uma cópia em CSV?')) {
            downloadCSV(data);
          }

        } catch (error) {
          console.error('Erro ao enviar:', error);
          successBox.style.color = '#a00';
          successBox.innerHTML = `<strong>❌ Erro ao enviar</strong><br>
            ${error.message || 'Não foi possível conectar ao servidor.'}<br>
            <button type="button" onclick="downloadCSV(collectData())" style="margin-top:10px;padding:8px 16px;background:var(--verde);color:#fff;border:none;border-radius:8px;cursor:pointer">
              Baixar CSV como backup
            </button>`;
        }

        window.scrollTo({top:0,behavior:'smooth'});
      }

      // Funcao para download CSV (backup)
      function downloadCSV(data) {
        const headers = Object.keys(data);
        const row = headers.map(h => `"${String(data[h]||'').replace(/"/g,'""')}"`);
        const csv = headers.join(',') + '\n' + row.join(',');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const fname = 'renova_produtor_' + (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-') + '.csv';
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fname;
        document.body.appendChild(link);
        link.click();
        link.remove();
      }

      // validate step requireds
      function validateStep(i){
        const requireds = steps[i].querySelectorAll('[required]');
        for(const el of requireds){
          if((el.type === 'checkbox' && !el.checked) || (el.type !== 'file' && !el.value)){
            el.scrollIntoView({behavior:'smooth',block:'center'});
            el.focus();
            alert('Por favor preencha os campos obrigatórios desta etapa.');
            return false;
          }
        }
        return true;
      }

      // make pills clickable
      pills.forEach((p, idx) => {
        p.style.cursor = 'pointer';
        p.addEventListener('click', ()=> {
          if(idx > current && !validateStep(current)) return;
          showStep(idx);
        });
      });

      // init
      showStep(0);

      // expose functions
      window.nextStep = window.nextStep;
      window.prevStep = window.prevStep;
      window.finalizeForm = finalizeForm;
    })();
  </script>
</body>
</html>
