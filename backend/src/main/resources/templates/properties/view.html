<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${property.name} + ' - RenovaCampo'">Propriedade - RenovaCampo</title>
    
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <!-- Shared Header -->
    <div th:replace="~{fragments/header :: header('properties')}"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <h1 th:text="${property.name}">Nome da Propriedade</h1>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                        <span class="tag" th:text="${property.type}">Tipo</span>
                        <span style="color: #64748b;">
                            <i class="fas fa-map-marker-alt"></i>
                            <span th:text="${property.city + ', ' + property.state}">Cidade, Estado</span>
                        </span>
                    </div>
                </div>
                <div class="page-header-actions">
                    <a th:href="@{/properties/{id}/edit(id=${property.id})}" class="btn btn-secondary">
                        <i class="fas fa-edit"></i>
                        Editar
                    </a>
                    <a href="/properties" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Voltar
                    </a>
                </div>
            </div>

            <!-- Status de Publicação -->
            <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #EC6618;">
                <div class="card-body" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem;">
                    <div>
                        <h4 style="margin: 0 0 0.25rem 0; color: #374151;">
                            <i class="fas fa-globe"></i> Publicação no Site
                        </h4>
                        <p style="margin: 0; color: #64748b; font-size: 0.875rem;">
                            Ao ativar, esta terra aparecerá na seção "Terras Disponíveis" do site público.
                        </p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span th:id="'approval-status-' + ${property.id}"
                              th:class="${property.approved} ? 'status-badge status-completed' : 'status-badge status-planning'"
                              th:text="${property.approved} ? 'Publicada' : 'Aguardando Aprovação'">
                            Status
                        </span>
                        <label class="toggle-switch">
                            <input type="checkbox"
                                   th:id="'approval-toggle-' + ${property.id}"
                                   th:checked="${property.approved}"
                                   th:onclick="'togglePropertyApproval(' + ${property.id} + ')'">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2" style="align-items: start;">
                <!-- Property Details -->
                <div>
                    <!-- Basic Info -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3>Informações Básicas</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-1" style="gap: 1rem;">
                                <div>
                                    <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.25rem;">Descrição:</label>
                                    <p th:text="${property.description}" style="color: #64748b; margin: 0;">Descrição da propriedade</p>
                                </div>
                                
                                <div class="grid grid-cols-2">
                                    <div>
                                        <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.25rem;">Área Total:</label>
                                        <p style="margin: 0;">
                                            <span th:text="${property.totalArea}">0</span> hectares
                                        </p>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.25rem;">Área Disponível:</label>
                                        <p style="margin: 0;">
                                            <span th:if="${property.availableArea}" 
                                                  th:text="${property.availableArea + ' hectares'}">0 hectares</span>
                                            <span th:unless="${property.availableArea}" 
                                                  style="color: #64748b;">Não informado</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3>Localização</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-1" style="gap: 1rem;">
                                <div th:if="${property.address}">
                                    <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.25rem;">Endereço:</label>
                                    <p th:text="${property.address}" style="color: #64748b; margin: 0;">Endereço</p>
                                </div>
                                
                                <div class="grid grid-cols-2">
                                    <div>
                                        <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.25rem;">Cidade:</label>
                                        <p th:text="${property.city}" style="margin: 0;">Cidade</p>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.25rem;">Estado:</label>
                                        <p th:text="${property.state}" style="margin: 0;">Estado</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2" 
                                     th:if="${property.latitude != null and property.longitude != null}">
                                    <div>
                                        <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.25rem;">Latitude:</label>
                                        <p th:text="${property.latitude}" style="margin: 0;">-</p>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.25rem;">Longitude:</label>
                                        <p th:text="${property.longitude}" style="margin: 0;">-</p>
                                    </div>
                                </div>
                                
                                <!-- Map -->
                                <div th:if="${property.latitude != null and property.longitude != null}" style="margin-top: 1rem;">
                                    <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.5rem;">Localização no Mapa:</label>
                                    <div id="property-map" style="height: 300px; border-radius: 0.5rem; border: 1px solid #e2e8f0;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photos and Documents -->
                <div>
                    <!-- Photos Section -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3><i class="fas fa-images" style="color: #EC6618;"></i> Fotos da Propriedade</h3>
                        </div>
                        <div class="card-body" id="photos-section">
                            <p class="no-data">Carregando fotos...</p>
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-file-alt" style="color: #EC6618;"></i> Documentos</h3>
                        </div>
                        <div class="card-body" id="documents-section">
                            <p class="no-data">Carregando documentos...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dados Extras do Formulário - Exibidos automaticamente -->
            <div class="card" style="margin-top: 1.5rem;" th:if="${property.additionalData != null and !property.additionalData.isEmpty()}">
                <div class="card-header">
                    <h3><i class="fas fa-clipboard-list" style="color: #EC6618;"></i> Dados do Formulário</h3>
                </div>
                <div class="card-body" id="additional-data-content">
                    <p class="no-data">Carregando dados...</p>
                </div>
            </div>

            <script th:inline="javascript">
                var additionalDataRaw = /*[[${property.additionalData}]]*/ null;
                var propertyId = /*[[${property.id}]]*/ 0;
            </script>
        </div>
    </main>

        <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Scripts -->
    <script>
        // Labels amigaveis para os campos do formulario
        const fieldLabels = {
            'nome_prop': 'Nome do Proprietario',
            'cpf_cnpj': 'CPF/CNPJ',
            'email': 'E-mail',
            'telefone': 'Telefone',
            'end_resid': 'Endereco Residencial',
            'horário_contato': 'Melhor Horario para Contato',
            'nome_propriedade': 'Nome da Propriedade',
            'end_prop': 'Endereco da Propriedade',
            'área_total': 'Area Total (ha)',
            'área_disp': 'Area Disponivel (ha)',
            'geolink': 'Geolocalizacao',
            'matricula': 'Matricula do Imovel',
            'sit_registral': 'Situacao Registral',
            'uso_atual': 'Uso Atual',
            'ultimas_culturas': 'Ultimas Culturas',
            'água_fontes': 'Fontes de Agua',
            'outorga': 'Outorga de Agua',
            'irrigacao': 'Irrigacao',
            'benfe': 'Benfeitorias',
            'reserva_legal': 'Reserva Legal',
            'apps': 'APPs',
            'modalidade_interesse': 'Modalidade de Interesse',
            'aluguel_proposto': 'Aluguel Proposto',
            'prazo_min': 'Prazo Minimo (anos)',
            'autoriza_visita': 'Autoriza Visitas Tecnicas',
            'condicoes_essenciais': 'Condicoes Essenciais',
            'assinatura': 'Assinatura Digital',
            'data_assinatura': 'Data da Assinatura'
        };

        // Campos a ignorar na exibicao
        const ignoreFields = ['timestamp', 'fotos', 'doc_matricula', 'doc_ccir', 'doc_cer', 'arrend_upload', 'soil_files', 'outorga_upload', 'reserva_files', 'apps_upload', 'mapa_upload', 'outros_docs', 'upload_kml'];

        // Carregar fotos da propriedade
        function loadPhotos() {
            const container = document.getElementById('photos-section');

            fetch('/api/v1/photos/property/' + propertyId)
                .then(response => response.ok ? response.json() : [])
                .then(photos => {
                    if (photos.length === 0) {
                        container.innerHTML = '<p class="no-data">Nenhuma foto cadastrada.</p>';
                        return;
                    }

                    let html = '<div class="photos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">';
                    photos.forEach(photo => {
                        html += `
                            <div class="photo-item" style="position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <a href="/api/v1/photos/${photo.id}" target="_blank">
                                    <img src="/api/v1/photos/${photo.id}" alt="${photo.originalFileName}"
                                         style="width: 100%; height: 120px; object-fit: cover;">
                                </a>
                                <div style="padding: 0.5rem; background: #f8fafc; font-size: 0.75rem; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${photo.originalFileName}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(() => {
                    container.innerHTML = '<p class="no-data">Erro ao carregar fotos.</p>';
                });
        }

        // Carregar documentos da propriedade
        function loadDocuments() {
            const container = document.getElementById('documents-section');

            fetch('/api/v1/files/property/' + propertyId)
                .then(response => response.ok ? response.json() : [])
                .then(files => {
                    const documents = files.filter(f => f.fileType === 'DOCUMENT');

                    if (documents.length === 0) {
                        container.innerHTML = '<p class="no-data">Nenhum documento cadastrado.</p>';
                        return;
                    }

                    let html = '<ul class="document-list" style="list-style: none; padding: 0; margin: 0;">';
                    documents.forEach(doc => {
                        const sizeKB = Math.round(doc.fileSize / 1024);
                        html += `
                            <li style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: #f8fafc; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #EC6618;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-file-pdf" style="font-size: 1.25rem; color: #014C34;"></i>
                                    <div>
                                        <div style="font-weight: 500; color: #1e293b;">${doc.originalFileName}</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">${sizeKB} KB</div>
                                    </div>
                                </div>
                                <a href="/api/v1/files/${doc.id}" target="_blank" style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 1rem; background: #014C34; color: white; border-radius: 4px; font-size: 0.8rem; text-decoration: none;">
                                    <i class="fas fa-download"></i> Baixar
                                </a>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    container.innerHTML = html;
                })
                .catch(() => {
                    container.innerHTML = '<p class="no-data">Erro ao carregar documentos.</p>';
                });
        }

        // Carregar dados adicionais do formulario
        function loadAdditionalData() {
            const container = document.getElementById('additional-data-content');

            if (!additionalDataRaw) {
                container.innerHTML = '<p class="no-data">Nenhum dado adicional disponivel.</p>';
                return;
            }

            try {
                const data = JSON.parse(additionalDataRaw);
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">';

                for (const [key, value] of Object.entries(data)) {
                    if (ignoreFields.includes(key) || !value || value === '') continue;

                    const label = fieldLabels[key] || key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1');
                    html += `
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; border-left: 3px solid #014C34;">
                            <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem;">${label}</div>
                            <div style="font-weight: 500; color: #1e293b;">${value}</div>
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
            } catch (e) {
                console.error('Erro ao parsear additionalData:', e);
                container.innerHTML = '<p class="no-data">Erro ao carregar dados adicionais.</p>';
            }
        }
        
        // Initialize map
        function initializeMap() {
            const lat = [[${property.latitude}]];
            const lon = [[${property.longitude}]];
            const propertyName = "[[${property.name}]]";
            
            console.log('Map initialization - lat:', lat, 'lon:', lon);
            
            if (lat !== null && lon !== null && document.getElementById('property-map')) {
                try {
                    // Initialize the map
                    const map = L.map('property-map').setView([lat, lon], 15);
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(map);
                    
                    // Create custom icon for property marker
                    const propertyIcon = L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: #EC6618; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    // Add marker for the property
                    L.marker([lat, lon], {icon: propertyIcon})
                        .addTo(map)
                        .bindPopup(`<strong>${propertyName}</strong><br>Lat: ${lat}<br>Lon: ${lon}`)
                        .openPopup();
                        
                    console.log('Map initialized successfully');
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            } else {
                console.log('Map not initialized - missing coordinates or map element');
            }
        }
        
        // Load on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPhotos();
            loadDocuments();
            loadAdditionalData();
            // Add small delay to ensure map container is ready
            setTimeout(initializeMap, 100);
        });

        // Toggle property approval for frontend display
        function togglePropertyApproval(propertyId) {
            fetch('/properties/' + propertyId + '/toggle-approval', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(status => {
                const statusBadge = document.getElementById('approval-status-' + propertyId);
                if (status === 'approved') {
                    statusBadge.className = 'status-badge status-completed';
                    statusBadge.textContent = 'Publicada';
                } else if (status === 'pending') {
                    statusBadge.className = 'status-badge status-planning';
                    statusBadge.textContent = 'Aguardando Aprovação';
                } else {
                    alert('Erro ao atualizar status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao atualizar status');
            });
        }
    </script>
    
    <style>
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
            color: #64748b;
            font-size: 0.875rem;
        }

        .loading-spinner i {
            font-size: 1.25rem;
            color: #3b82f6;
        }

        .loading-spinner span {
            font-weight: 500;
        }

        /* Custom map marker */
        .custom-marker {
            background: transparent !important;
            border: none !important;
        }

        .no-data {
            color: #94a3b8;
            font-style: italic;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 28px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #10b981;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(28px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
    </style>
</body>
</html>