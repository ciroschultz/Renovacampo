<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Renova Campo — Formulário detalhado para captação de terras</title>

  <style>
    /* === Theme (unificado com visual do produtor) === */
    :root{
      --accent:#2b8a3e;
      --muted:#666;
      --bg:#f7f9f8;
      --card:#ffffff;
      --maxw:980px;
      --radius:12px;
      --gap:12px;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{height:100%;margin:0;background:var(--bg);color:#123;}
    .container{max-width:var(--maxw);margin:28px auto;padding:20px}
    /* ===== new header to match producer form ===== */
    header.app-header{
      display:flex;
      gap:20px;
      align-items:center;
      margin-bottom:12px;
    }
    .logo {
      background:var(--card);
      padding:8px 12px;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(10,20,10,0.06);
      display:flex;
      align-items:center;
    }
    .logo img{height:62px; display:block;}
    .title-block{
      flex:1;
      background:transparent;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }
    .title-block h1{margin:0;font-size:22px;color:#0b3d1a;}
    .title-block p.lead{margin:0;color:var(--muted);font-size:14px}

    /* ===== original card/form styles ===== */
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(10,10,10,0.06)}
    .steps{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
    .step-pill{padding:8px 10px;border-radius:999px;background:#eef6ee;color:var(--muted);font-size:13px}
    .progress{height:8px;background:#e6efe6;border-radius:999px;overflow:hidden;margin:14px 0}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#60bd6b);width:0%}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type=text],input[type=email],input[type=number],input[type=date],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e3e7e3;background:#fff}
    textarea{min-height:90px}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .full{grid-column:1/-1}
    .actions{display:flex;justify-content:space-between;gap:10px;margin-top:18px}
    button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    button.secondary{background:#fff;color:var(--accent);border:1px solid #dbeadb}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
    .hidden{display:none}
    .small{font-size:13px;color:#444}
    .filelist{font-size:13px;color:var(--muted);margin-top:6px}
    .summary{background:#fbfffb;border:1px solid #e6f6e6;padding:12px;border-radius:8px;margin-top:12px}
    .score-high{color:green;font-weight:700}
    .score-medium{color:#b57a00;font-weight:700}
    .score-low{color:#a00;font-weight:700}
    .required{color:#a00;margin-left:6px}
    .tag{display:inline-block;background:#eef6ef;border-radius:999px;padding:6px 10px;margin-right:6px;font-size:13px}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border:1px solid #eee;padding:8px;text-align:left}

    @media (max-width:700px){.row{grid-template-columns:1fr}.container{padding:12px}}
  </style>
</head>
<body>
  <div class="container">

    <!-- ===== new header (logo left / title right) ===== -->
    <header class="app-header">
      <div class="logo" aria-hidden="true">
        <img src="Captura de tela 2025-10-07 210445.png" alt="Logo Renova Campo">
      </div>
      <div class="title-block">
        <h1>Renova Campo — Formulário detalhado para captação de terras</h1>
        <p class="lead">Preencha com atenção. Tempo estimado: <strong>15–25 minutos</strong>. Campos obrigatórios têm (<span class="required">*</span>).</p>
      </div>
    </header>

    <div class="card">
      <!-- ===== pills / etapas (idêntico ao seu original) ===== -->
      <div class="steps" aria-hidden="true">
        <div class="step-pill">1 Proprietário</div>
        <div class="step-pill">2 Propriedade</div>
        <div class="step-pill">3 Documentos</div>
        <div class="step-pill">4 Solo & Água</div>
        <div class="step-pill">5 Infra & Ambiental</div>
        <div class="step-pill">6 Produção</div>
        <div class="step-pill">7 Modelo & Financeiro</div>
        <div class="step-pill">8 Sociais & Anexos</div>
        <div class="step-pill">9 Confirmação</div>
      </div>

      <div class="progress" aria-hidden>
        <i id="progressBar" style="width:11%"></i>
      </div>

      <!-- ===== FORM (mesmo conteúdo e scripts do seu HTML original) ===== -->
      <form id="renovaForm" onsubmit="return false;">

        <!-- STEP 1 -->
        <fieldset class="form-step" data-step="1">
          <label>Nome completo <span class="required">*</span></label>
          <input id="nome_prop" type="text" placeholder="Nome do proprietário" required />

          <div class="row">
            <div>
              <label>CPF / CNPJ <span class="required">*</span></label>
              <input id="cpf_cnpj" type="text" placeholder="000.000.000-00 ou 00.000.000/0000-00" required />
              <div class="note">Formato aceitável: CPF ou CNPJ. O campo será validado de forma básica.</div>
            </div>
            <div>
              <label>E-mail <span class="required">*</span></label>
              <input id="email" type="email" placeholder="contato@exemplo.com" required />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Telefone / WhatsApp <span class="required">*</span></label>
              <input id="telefone" type="text" placeholder="(99) 9 9999-9999" required />
            </div>
            <div>
              <label>Endereço (município / UF) <span class="required">*</span></label>
              <input id="end_resid" type="text" placeholder="Ex: Aclimação, São Paulo - SP" required />
            </div>
          </div>

          <label>Melhor horário para contato / visita</label>
          <select id="horario_contato">
            <option>Manhã</option>
            <option>Tarde</option>
            <option>Noite</option>
            <option>Fim de semana</option>
          </select>

          <div class="actions">
            <div></div>
            <div>
              <button type="button" onclick="nextStep()">Próximo ▶</button>
            </div>
          </div>
        </fieldset>

        <!-- STEP 2 -->
        <fieldset class="form-step hidden" data-step="2">
          <label>Nome da propriedade</label>
          <input id="nome_propiedade" type="text" placeholder="Nome da fazenda/sítio" />

          <div class="row">
            <div>
              <label>Endereço da propriedade (município / UF) <span class="required">*</span></label>
              <input id="end_prop" type="text" placeholder="Município / UF" required />
            </div>
            <div>
              <label>Área total (ha) <span class="required">*</span></label>
              <input id="area_total" type="number" min="0" step="0.01" placeholder="Ex.: 120" required />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Área disponível para arrendamento (ha) <span class="required">*</span></label>
              <input id="area_disp" type="number" min="0" step="0.01" placeholder="Ex.: 60" required />
            </div>
            <div>
              <label>Geolocalização / link Google Maps / lat,long <span class="required">*</span></label>
              <input id="geolink" type="text" placeholder="https://maps.google.com/... ou -23.550520,-46.633308" required />
            </div>
          </div>

          <label>Upload KML / GEOJSON (opcional)</label>
          <input id="upload_kml" type="file" accept=".kml,.kmz,.geojson" />
          <div class="note">Se tiver, envie KML/KMZ/GEOJSON para facilitar análise técnica.</div>

          <label>Matrícula do imóvel (nº / Cartório) <span class="required">*</span></label>
          <input id="matricula" type="text" placeholder="Número da matrícula" required />

          <label>Situação registral</label>
          <select id="sit_registral">
            <option>Escritura registrada</option>
            <option>Posse com documentação parcial</option>
            <option>Em inventário</option>
            <option>Em litígio</option>
            <option>Outro</option>
          </select>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 3 -->
        <fieldset class="form-step hidden" data-step="3">
          <label>Upload — Certidão de Matrícula atualizada (PDF) <span class="required">*</span></label>
          <input id="doc_matricula" type="file" accept="application/pdf" required />

          <label>Upload — CCIR ou documento equivalente (se aplicável)</label>
          <input id="doc_ccir" type="file" accept="application/pdf" />

          <label>Upload — Certidões (negativas / ambientais) — (opcional)</label>
          <input id="doc_cer" type="file" accept="application/pdf" multiple />

          <label>Existe arrendamento ou contrato vigente na propriedade?</label>
          <select id="arrend_vigente" onchange="toggleContract(this.value)">
            <option>Não</option>
            <option>Sim</option>
          </select>
          <div id="arrend_desc" class="hidden">
            <label>Descreva o contrato vigente (data fim, valores, partes) e envie cópia</label>
            <textarea id="arrend_text"></textarea>
            <input id="arrend_upload" type="file" accept="application/pdf" />
          </div>

          <label>Existe penhora, hipoteca ou ônus sobre o imóvel?</label>
          <select id="onus" onchange="toggleOnus(this.value)">
            <option>Não</option>
            <option>Sim</option>
          </select>
          <div id="onus_desc" class="hidden">
            <label>Explique o ônus</label>
            <textarea id="onus_text"></textarea>
          </div>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 4 -->
        <fieldset class="form-step hidden" data-step="4">
          <label>Uso atual da terra (marque todas que se aplicam)</label>
          <div>
            <label class="tag"><input type="checkbox" value="Pastagem" class="uso_atual"> Pastagem</label>
            <label class="tag"><input type="checkbox" value="Agricultura anual" class="uso_atual"> Agricultura anual</label>
            <label class="tag"><input type="checkbox" value="Silvicultura" class="uso_atual"> Silvicultura</label>
            <label class="tag"><input type="checkbox" value="Área degradada" class="uso_atual"> Área degradada / em recuperação</label>
            <label class="tag"><input type="checkbox" value="Floresta" class="uso_atual"> Floresta / Reserva</label>
            <label class="tag"><input type="checkbox" value="Agrofloresta" class="uso_atual"> Agrofloresta</label>
            <label class="tag"><input type="checkbox" value="Outro" class="uso_atual"> Outro</label>
          </div>

          <label>Últimas culturas / uso nos últimos 5 anos</label>
          <textarea id="ultimas_culturas" placeholder="Ex: 2021 - pastagem; 2022 - soja; 2023 - pousio"></textarea>

          <label>Existem análises de solo disponíveis?</label>
          <select id="soil_analise" onchange="toggleSoilUpload(this.value)">
            <option>Não</option>
            <option>Sim</option>
          </select>
          <div id="soil_upload" class="hidden">
            <label>Upload — Relatórios/analises de solo (PDF)</label>
            <input id="soil_files" type="file" accept="application/pdf" multiple />
            <label>Data da última análise</label>
            <input id="soil_data" type="date" />
          </div>

          <label>Observações sobre erosão, salinização, áreas críticas</label>
          <textarea id="obs_erosao"></textarea>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 5 -->
        <fieldset class="form-step hidden" data-step="5">
          <label>Fontes de água na propriedade (marque todas que se aplicam)</label>
          <div>
            <label class="tag"><input type="checkbox" value="Nascentes" class="agua_fontes"> Nascentes</label>
            <label class="tag"><input type="checkbox" value="Rio" class="agua_fontes"> Rio/Riacho</label>
            <label class="tag"><input type="checkbox" value="Açude" class="agua_fontes"> Açude</label>
            <label class="tag"><input type="checkbox" value="Poço tubular" class="agua_fontes"> Poço tubular</label>
            <label class="tag"><input type="checkbox" value="Outorga" class="agua_fontes"> Outorga</label>
            <label class="tag"><input type="checkbox" value="Sem fonte registrada" class="agua_fontes"> Sem fonte registrada</label>
          </div>

          <label>Existe outorga de uso de água registrada?</label>
          <select id="outorga" onchange="toggleOutorga(this.value)">
            <option>Não</option>
            <option>Sim</option>
            <option>Não sei</option>
          </select>
          <div id="outorga_desc" class="hidden">
            <label>Nº da outorga / upload (se disponível)</label>
            <input id="outorga_num" type="text" placeholder="Número / processo" />
            <input id="outorga_upload" type="file" accept="application/pdf" />
          </div>

          <label>Capacidade estimada / vazão (se conhecida)</label>
          <input id="vazao" type="text" placeholder="Ex: 10 m3/h — poço X" />

          <label>Irrigação instalada?</label>
          <select id="irrigacao">
            <option>Não</option>
            <option>Sim — Pivô</option>
            <option>Sim — Gotejamento</option>
            <option>Outro</option>
          </select>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 6 -->
        <fieldset class="form-step hidden" data-step="6">
          <label>Benfeitorias existentes (marque e descreva)</label>
          <div>
            <label class="tag"><input type="checkbox" value="Casa sede" class="benfe"> Casa sede</label>
            <label class="tag"><input type="checkbox" value="Galpão" class="benfe"> Galpão / Armazém</label>
            <label class="tag"><input type="checkbox" value="Cercas" class="benfe"> Cercas</label>
            <label class="tag"><input type="checkbox" value="Currais" class="benfe"> Currais</label>
            <label class="tag"><input type="checkbox" value="Estradas" class="benfe"> Estradas internas</label>
            <label class="tag"><input type="checkbox" value="Energia" class="benfe"> Energia elétrica (próxima/instalada)</label>
            <label class="tag"><input type="checkbox" value="Internet" class="benfe"> Comunicações / Internet</label>
            <label class="tag"><input type="checkbox" value="Outro" class="benfe"> Outro</label>
          </div>

          <label>Estado das cercas e estradas</label>
          <div class="row">
            <div>
              <label>Cercas</label>
              <select id="estado_cercas"><option>Bom</option><option>Regular</option><option>Ruim</option></select>
            </div>
            <div>
              <label>Estradas internas</label>
              <select id="estado_estradas"><option>Bom</option><option>Regular</option><option>Ruim</option></select>
            </div>
          </div>

          <label>Existem construções/ investimentos que exigem compensação se o contrato terminar?</label>
          <select id="compensacoes" onchange="toggleComp(this.value)">
            <option>Não</option>
            <option>Sim</option>
          </select>
          <div id="comp_desc" class="hidden">
            <label>Descreva e informe valor estimado</label>
            <textarea id="comp_text"></textarea>
          </div>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 7 -->
        <fieldset class="form-step hidden" data-step="7">
          <label>Reserva Legal — existe e está regularizada?</label>
          <select id="reserva_legal" onchange="toggleReserva(this.value)">
            <option>Sim — regularizada</option>
            <option>Sim — não regularizada</option>
            <option>Não existe</option>
            <option>Desconheço</option>
          </select>
          <div id="reserva_upload" class="hidden">
            <label>Upload — Documentos da Reserva Legal</label>
            <input id="reserva_files" type="file" accept="application/pdf" multiple />
          </div>

          <label>APPs na propriedade?</label>
          <select id="apps" onchange="toggleApps(this.value)">
            <option>Não</option>
            <option>Sim</option>
            <option>Desconheço</option>
          </select>
          <div id="apps_desc" class="hidden">
            <label>Descreva as APPs / envie mapa</label>
            <textarea id="apps_text"></textarea>
            <input id="apps_upload" type="file" accept="application/pdf,.kml,.kmz" />
          </div>

          <label>Pendências ambientais (multas, autos, processos)</label>
          <select id="pend_env" onchange="togglePend(this.value)">
            <option>Não</option>
            <option>Sim</option>
          </select>
          <div id="pend_desc" class="hidden">
            <label>Explique</label>
            <textarea id="pend_text"></textarea>
          </div>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 8 -->
        <fieldset class="form-step hidden" data-step="8">
          <label>Produção atual (lista)</label>
          <div class="note">Adicione atividades com área utilizada e produtividade média.</div>
          <table class="table" id="prod_table">
            <thead><tr><th>Atividade</th><th>Área (ha)</th><th>Produtividade média</th><th>Destino</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="margin-top:10px">
            <input id="prod_act" type="text" placeholder="Ex: Pastagem / Soja" />
            <input id="prod_area" type="number" step="0.01" placeholder="ha" style="width:90px;margin-left:8px" />
            <input id="prod_produt" type="text" placeholder="Produtividade (ex: 2 t/ha)" style="width:180px;margin-left:8px" />
            <input id="prod_dest" type="text" placeholder="Destino (venda/autoconsumo)" style="width:160px;margin-left:8px" />
            <button type="button" onclick="addProd()">Adicionar</button>
          </div>

          <label>Existe comprador / contrato (off-take)?</label>
          <select id="offtake">
            <option>Não</option>
            <option>Sim</option>
          </select>
          <div id="offtake_upload" class="hidden">
            <label>Upload — contrato off-take (opcional)</label>
            <input id="offtake_doc" type="file" accept="application/pdf" />
          </div>

          <label>Rendimento médio anual (R$ por ha ou total)</label>
          <input id="rendimento" type="text" placeholder="Estimativa de faturamento" />

          <label>Certificações (orgânico / regenerativo / outro)</label>
          <input id="certificacoes" type="text" placeholder="Especifique se houver" />

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 9 -->
        <fieldset class="form-step hidden" data-step="9">
          <label>Modalidade de interesse <span class="required">*</span></label>
          <select id="modalidade_interesse" onchange="toggleModal(this.value)" required>
            <option value="modal1">Modalidade 1 — Financiamento da safra (aluguel X)</option>
            <option value="modal2">Modalidade 2 — Estruturação empresarial (participação / sociedade)</option>
            <option value="indeciso">Indeciso / Outro</option>
          </select>

          <div id="modal1_box" class="hidden">
            <label>Se Modalidade 1 — valor de aluguel proposto (R$/ha por safra ou R$/ano)</label>
            <input id="aluguel_proposto" type="number" step="0.01" placeholder="Informe valor em R$" />
            <div class="note">Se desejar formula de correção (ex.: IPCA + X%), descreva abaixo.</div>
            <input id="aluguel_formula" type="text" placeholder="Ex.: IPCA + 3%" />
          </div>

          <div id="modal2_box" class="hidden">
            <label>Se Modalidade 2 — interesse em ser sócio aportando a terra?</label>
            <select id="modal2_participa">
              <option>Não</option>
              <option>Sim — integralmente</option>
              <option>Sim — parcialmente</option>
              <option>Depende da proposta</option>
            </select>
            <label>Se sim, expectativa de valuation (R$/ha) ou método preferido</label>
            <input id="valuation" type="text" placeholder="Ex: R$ 8.000/ha — ou FCD" />
          </div>

          <label>Prazo mínimo desejado para contrato/participação (anos)</label>
          <input id="prazo_min" type="number" min="1" placeholder="Ex: 3" />

          <label>Você autoriza visitas técnicas e amostragens (solo/água)?</label>
          <select id="autoriza_visita">
            <option>Sim</option>
            <option>Não</option>
          </select>

          <label>Condições essenciais exigidas pelo proprietário</label>
          <textarea id="condicoes_essenciais" placeholder="Proibições, exigências, cláusulas essenciais..."></textarea>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- FINAL / SUBMIT (mantive a lógica original de gerar CSV e resumo) -->
        <fieldset class="form-step hidden" data-step="10">
          <label>Há trabalhadores regulares na propriedade? Informe nº e regime</label>
          <input id="trab_regulares" type="text" placeholder="Ex: 4 — 2 CLT, 2 diaristas" />

          <label>Há comunidades tradicionais ou indígenas próximas / internas?</label>
          <select id="comunidades"><option>Não</option><option>Sim</option><option>Não sei</option></select>

          <label>Conflitos locais conhecidos (uso de terra, água, titularidade)?</label>
          <select id="conflitos" onchange="toggleConflitos(this.value)"><option>Não</option><option>Sim</option></select>
          <div id="conflitos_desc" class="hidden">
            <label>Descreva</label>
            <textarea id="conflitos_text"></textarea>
          </div>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 11 (arquivos / fotos / anexos) -->
        <fieldset class="form-step hidden" data-step="11">
          <label>Fotos — upload (mínimo 6 imagens recomendadas)</label>
          <input id="fotos" type="file" accept="image/*" multiple />
          <div class="note">Envie imagens: sede, pastagens/plantios, água, cercas, estradas, pontos críticos.</div>

          <label>Mapa ou sobreposição aérea (upload)</label>
          <input id="mapa_upload" type="file" accept="image/*,application/pdf,.kml,.kmz" />

          <label>Outros documentos relevantes (contratos, laudos)</label>
          <input id="outros_docs" type="file" accept="application/pdf" multiple />

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="nextStep()">Próximo ▶</button>
          </div>
        </fieldset>

        <!-- STEP 12 (confirm / declaration / signature) -->
        <fieldset class="form-step hidden" data-step="12">
          <label>Declaração e autorização <span class="required">*</span></label>
          <div class="small">Declaro que as informações prestadas são verdadeiras e autorizo a Renova Campo a realizar análises iniciais e visitas técnicas.</div>
          <label style="margin-top:10px"><input id="declaro" type="checkbox" required /> Concordo</label>

          <label>Assinatura digital (nome completo) <span class="required">*</span></label>
          <input id="assinatura" type="text" placeholder="Nome completo" required />

          <label>Data</label>
          <input id="data_assinatura" type="date" />

          <label>Consentimento para uso de imagens no site / material</label>
          <select id="consent_imagem"><option>Sim</option><option>Não</option><option>Somente após autorização explícita</option></select>

          <div class="actions">
            <button type="button" class="secondary" onclick="prevStep()">◀ Anterior</button>
            <button type="button" onclick="finalizeForm()">Enviar e Baixar CSV</button>
          </div>

          <div id="resultado" class="summary hidden" aria-live="polite"></div>
        </fieldset>

      </form>

      <div style="margin-top:12px" class="note small">Observação: este formulário é uma solução front-end. Os arquivos enviados ficam no navegador do usuário — para receber envios em servidor, será preciso configurar integração com backend ou Google Forms. Ao enviar, você receberá um arquivo CSV com os dados preenchidos para importação manual em seu CRM.</div>
    </div>
  </div>

  <script>
    // ===== original wizard control & helpers (mantidos do seu HTML) =====
    const steps = document.querySelectorAll('.form-step');
    let current = 0;
    showStep(current);

    function showStep(n){
      steps.forEach((s,i)=> s.classList.toggle('hidden', i!==n));
      const progress = Math.round(((n+1)/steps.length)*100);
      document.getElementById('progressBar').style.width = progress + '%';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function nextStep(){
      if(!validateStep(current)) return;
      if(current < steps.length-1) current++;
      showStep(current);
    }
    function prevStep(){ if(current>0){ current--; showStep(current);} }

    // Toggle helpers
    function toggleContract(val){ document.getElementById('arrend_desc')?.classList.toggle('hidden', val!=='Sim'); }
    function toggleOnus(val){ document.getElementById('onus_desc')?.classList.toggle('hidden', val!=='Sim'); }
    function toggleSoilUpload(val){ document.getElementById('soil_upload')?.classList.toggle('hidden', val!=='Sim'); }
    function toggleOutorga(val){ document.getElementById('outorga_desc')?.classList.toggle('hidden', val!=='Sim'); }
    function toggleComp(val){ document.getElementById('comp_desc')?.classList.toggle('hidden', val!=='Sim'); }
    function toggleReserva(val){ document.getElementById('reserva_upload')?.classList.toggle('hidden', val!=='Sim — regularizada'); }
    function toggleApps(val){ document.getElementById('apps_desc')?.classList.toggle('hidden', val!=='Sim'); }
    function togglePend(val){ document.getElementById('pend_desc')?.classList.toggle('hidden', val!=='Sim'); }
    function toggleConflitos(val){ document.getElementById('conflitos_desc')?.classList.toggle('hidden', val!=='Sim'); }

    function toggleModal(val){
      document.getElementById('modal1_box')?.classList.toggle('hidden', val!=='modal1');
      document.getElementById('modal2_box')?.classList.toggle('hidden', val!=='modal2');
    }

    // Offtake logic
    document.getElementById('offtake')?.addEventListener('change', function(){
      document.getElementById('offtake_upload')?.classList.toggle('hidden', this.value!=='Sim');
    });

    // Production table
    function addProd(){
      const act = document.getElementById('prod_act').value.trim();
      const area = document.getElementById('prod_area').value;
      const prod = document.getElementById('prod_produt').value;
      const dest = document.getElementById('prod_dest').value;
      if(!act || !area){ alert('Preencha pelo menos atividade e área.'); return; }
      const tbody = document.querySelector('#prod_table tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(act)}</td><td>${escapeHtml(area)}</td><td>${escapeHtml(prod)}</td><td>${escapeHtml(dest)}</td><td><button type="button" onclick="this.closest('tr').remove()">Remover</button></td>`;
      tbody.appendChild(tr);
      document.getElementById('prod_act').value=''; document.getElementById('prod_area').value=''; document.getElementById('prod_produt').value=''; document.getElementById('prod_dest').value='';
    }

    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

    // Validation per step
    function validateStep(i){
      const step = steps[i];
      const requireds = step.querySelectorAll('[required]');
      for(const el of requireds){
        if((el.type==='checkbox' && !el.checked) || (el.type!=='checkbox' && !el.value)){ el.focus(); alert('Por favor preencha os campos obrigatórios.'); return false; }
      }
      if(i===0){
        const cpfEl = document.getElementById('cpf_cnpj');
        if(cpfEl){
          const cpf = cpfEl.value.replace(/\D/g,'');
          if(!(cpf.length===11 || cpf.length===14)){ alert('CPF ou CNPJ inválido — verifique o formato.'); return false; }
        }
      }
      if(i===10){
        const fotos = document.getElementById('fotos');
        if(fotos && fotos.files.length>0 && fotos.files.length<6){ if(!confirm('Você enviou menos de 6 fotos. Deseja continuar?')) return false; }
      }
      return true;
    }

    // Collect & finalize (CSV)
    function collectData(){
      const data = {};
      data.nome = document.getElementById('nome_prop')?.value.trim();
      data.cpf_cnpj = document.getElementById('cpf_cnpj')?.value.trim();
      data.email = document.getElementById('email')?.value.trim();
      data.telefone = document.getElementById('telefone')?.value.trim();
      data.end_resid = document.getElementById('end_resid')?.value.trim();
      data.horario_contato = document.getElementById('horario_contato')?.value;

      data.nome_propriedade = document.getElementById('nome_propiedade')?.value.trim();
      data.end_prop = document.getElementById('end_prop')?.value.trim();
      data.area_total = parseFloat(document.getElementById('area_total')?.value) || 0;
      data.area_disp = parseFloat(document.getElementById('area_disp')?.value) || 0;
      data.geo = document.getElementById('geolink')?.value.trim();
      data.matricula = document.getElementById('matricula')?.value.trim();
      data.sit_registral = document.getElementById('sit_registral')?.value;

      data.arrend_vigente = document.getElementById('arrend_vigente')?.value;
      data.arrend_text = document.getElementById('arrend_text')?.value.trim();
      data.onus = document.getElementById('onus')?.value;
      data.onus_text = document.getElementById('onus_text')?.value.trim();

      data.uso_atual = Array.from(document.querySelectorAll('.uso_atual:checked')).map(i=>i.value);
      data.ultimas_culturas = document.getElementById('ultimas_culturas')?.value.trim();
      data.soil_analise = document.getElementById('soil_analise')?.value;
      data.soil_data = document.getElementById('soil_data')?.value;
      data.obs_erosao = document.getElementById('obs_erosao')?.value;

      data.agua_fontes = Array.from(document.querySelectorAll('.agua_fontes:checked')).map(i=>i.value);
      data.outorga = document.getElementById('outorga')?.value;
      data.vazao = document.getElementById('vazao')?.value;
      data.irrigacao = document.getElementById('irrigacao')?.value;

      data.benfeitorias = Array.from(document.querySelectorAll('.benfe:checked')).map(i=>i.value);
      data.estado_cercas = document.getElementById('estado_cercas')?.value;
      data.estado_estradas = document.getElementById('estado_estradas')?.value;
      data.compensacoes = document.getElementById('compensacoes')?.value;
      data.comp_text = document.getElementById('comp_text')?.value.trim();

      data.reserva_legal = document.getElementById('reserva_legal')?.value;
      data.apps = document.getElementById('apps')?.value;
      data.pend_env = document.getElementById('pend_env')?.value;
      data.pend_text = document.getElementById('pend_text')?.value.trim();

      const prods = [];
      document.querySelectorAll('#prod_table tbody tr').forEach(tr =>{
        const tds = tr.querySelectorAll('td');
        prods.push({atividade:tds[0].innerText,area:tds[1].innerText,produtividade:tds[2].innerText,destino:tds[3].innerText});
      });
      data.producao = prods;
      data.offtake = document.getElementById('offtake')?.value;
      data.rendimento = document.getElementById('rendimento')?.value;
      data.certificacoes = document.getElementById('certificacoes')?.value;

      data.modalidade = document.getElementById('modalidade_interesse')?.value;
      data.aluguel = document.getElementById('aluguel_proposto')?.value;
      data.aluguel_formula = document.getElementById('aluguel_formula')?.value;
      data.modal2_participa = document.getElementById('modal2_participa')?.value;
      data.valuation = document.getElementById('valuation')?.value;
      data.prazo_min = document.getElementById('prazo_min')?.value;
      data.autoriza_visita = document.getElementById('autoriza_visita')?.value;
      data.condicoes = document.getElementById('condicoes_essenciais')?.value;

      data.investidores = document.getElementById('investidores')?.value;
      data.exige_seguro = document.getElementById('exige_seguro')?.value;
      data.preferencia_renda = document.getElementById('preferencia_renda')?.value;

      data.trab_regulares = document.getElementById('trab_regulares')?.value;
      data.comunidades = document.getElementById('comunidades')?.value;
      data.conflitos = document.getElementById('conflitos')?.value;
      data.conflitos_text = document.getElementById('conflitos_text')?.value.trim();

      data.fotos = Array.from(document.getElementById('fotos')?.files||[]).map(f=>f.name);
      data.mapa_upload = document.getElementById('mapa_upload')?.files.length>0 ? document.getElementById('mapa_upload').files[0].name : '';
      data.outros_docs = Array.from(document.getElementById('outros_docs')?.files||[]).map(f=>f.name);

      data.declaro = document.getElementById('declaro')?.checked;
      data.assinatura = document.getElementById('assinatura')?.value;
      data.data_assinatura = document.getElementById('data_assinatura')?.value;
      data.consent_imagem = document.getElementById('consent_imagem')?.value;

      data.timestamp = new Date().toISOString();
      return data;
    }

    function finalizeForm(){
      if(!validateStep(current)) return;
      if(!document.getElementById('declaro')?.checked){ alert('É necessário concordar com a declaração.'); return; }
      const data = collectData();
      const headers = ['timestamp','nome','cpf_cnpj','email','telefone','end_resid','horario_contato','nome_propriedade','end_prop','area_total','area_disp','geo','matricula','sit_registral','uso_atual','ultimas_culturas','soil_analise','soil_data','agua_fontes','outorga','irrigacao','benfeitorias','estado_cercas','estado_estradas','reserva_legal','apps','pend_env','producao_json','modalidade','aluguel','modal2_participa','valuation','prazo_min','autoriza_visita','condicoes','investidores','exige_seguro','preferencia_renda','trab_regulares','comunidades','conflitos','fotos','mapa_upload','outros_docs','assinatura','data_assinatura','consent_imagem'];
      const row = [
        data.timestamp,data.nome,data.cpf_cnpj,data.email,data.telefone,data.end_resid,data.horario_contato,
        data.nome_propriedade,data.end_prop,data.area_total,data.area_disp,data.geo,data.matricula,data.sit_registral,
        '"'+(data.uso_atual.join('; '))+'"', '"'+(data.ultimas_culturas||'')+'"', data.soil_analise,data.soil_data,'"'+(data.agua_fontes.join('; '))+'"', data.outorga,data.irrigacao,
        '"'+(data.benfeitorias.join('; '))+'"', data.estado_cercas,data.estado_estradas,data.reserva_legal,data.apps,data.pend_env,'"'+JSON.stringify(data.producao).replace(/"/g,'""')+'"',
        data.modalidade,data.aluguel,data.modal2_participa,data.valuation,data.prazo_min,data.autoriza_visita,'"'+(data.condicoes||'')+'"',
        data.investidores,data.exige_seguro,data.preferencia_renda,'"'+data.trab_regulares+'"',data.comunidades,data.conflitos,'"'+(data.fotos.join('; '))+'"',data.mapa_upload,'"'+(data.outros_docs.join('; '))+'"',data.assinatura,data.data_assinatura,data.consent_imagem
      ];
      const csvContent = headers.join(',') + '\n' + row.join(',');
      const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
      const fname = 'renova_captação_' + (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-') + '.csv';
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = fname;
      document.body.appendChild(link);
      link.click();
      link.remove();

      const res = document.getElementById('resultado');
      res.classList.remove('hidden');
      res.innerHTML = `<strong>Enviado!</strong> Obrigado, ${data.nome||'usuário'}.<br>Um arquivo CSV foi gerado para download.`;
      localStorage.setItem('renova_last_submission', JSON.stringify(data));
    }

    // initialize listeners
    document.getElementById('arrend_vigente')?.addEventListener('change', e=> toggleContract(e.target.value));
    document.getElementById('onus')?.addEventListener('change', e=> toggleOnus(e.target.value));
    document.getElementById('soil_analise')?.addEventListener('change', e=> toggleSoilUpload(e.target.value));
    document.getElementById('outorga')?.addEventListener('change', e=> toggleOutorga(e.target.value));
    document.getElementById('compensacoes')?.addEventListener('change', e=> toggleComp(e.target.value));
    document.getElementById('reserva_legal')?.addEventListener('change', e=> toggleReserva(e.target.value));
    document.getElementById('apps')?.addEventListener('change', e=> toggleApps(e.target.value));
    document.getElementById('pend_env')?.addEventListener('change', e=> togglePend(e.target.value));
    document.getElementById('offtake')?.addEventListener('change', e=> document.getElementById('offtake_upload')?.classList.toggle('hidden', e.target.value!=='Sim'));
    document.getElementById('modalidade_interesse')?.addEventListener('change', e=> toggleModal(e.target.value));
    document.getElementById('conflitos')?.addEventListener('change', e=> toggleConflitos(e.target.value));

  </script>
</body>
</html>
